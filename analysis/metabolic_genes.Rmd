---
title: "Analysis of metabolic genes"
site: workflowr::wflow_site
bibliography: ../data/references/references.bib
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE
)
```


# Introduction
This script analyzes the expression of genes involved in the metabolism of 
xenobiotic substances in one of our previously published mouse model that 
develops chronic liver disease induced by administration of CCl~4~ for 2, 6 and 
12 months [@Holland2021]. 

The focus is on the following gene families:

* Phase I Metablism
  + Cytochrome p450 dependent monooxygenase (CYP)
  + Flavin dependent monooxygenases (FMO)
  + Monoamine oxidase (MAO)
  + Cyclooxgenase (COX)
  + Dihydrodioldehydrogenase (DH)
  + DT-Diaphorase (NQOR)
  + Alcohol- and Aldehyddehydrogenase (ADH/ALDH)
  + Epoxidhydrolase (EPH)
* Phase II Metabolism
  + Glutathiontransferase (GST)
  + UDP-glucuronosyltransferase (UGT)
  + Sulfotransferase (SULT)
  + Acetyltransferase (NAT)
  + Methyltransferase (MT)
* Carrier
  + Blood side
  + Canalicular side

# Libraries and sources
These libraries and sources are used for this analysis.
```{r libs-and-src, message=FALSE, warning=FALSE, cache=FALSE, echo=TRUE}
# data wrangling
library(tidyverse)

# statistics
library(fgsea)
library(msigdf)
library(survcomp)

# plotting
library(cowplot)
library(lemon)
library(tidytext)
library(UpSetR)
library(plotly)
library(scales)
library(patchwork)
library(gtools)

# colors
library(AachenColorPalette)
library(RColorBrewer)

# display tables
library(DT)
library(knitr)

# development helpers
library(here)
library(devtools)

# other
library(htmltools)

# source scripts
source(here("code/plots.R"))

# source scripts from external projects
base_url <- "https://raw.githubusercontent.com/saezlab/liver-disease-atlas"
source_url(file.path(base_url, "master", "code", "utils-plots.R"))
source_url(file.path(base_url, "master", "code", "utils-utils.R"))
```

Definition of global variables that are used throughout this analysis.
```{r analysis-specific-params, cache=FALSE}
data_path <- "data/mouse-chronic-ccl4"
output_path <- "output/mouse-chronic-ccl4"
```

# Descriptive data analysis
## PCA plots
```{r pca-plots, fig.height=3}
# limit samples to 12 months
meta_pure_ccl4 <- readRDS(here(data_path, "meta_data.rds")) |>
  filter(time == 12)
expr_pure_ccl4 <- readRDS(
  here(data_path, "normalized_expression.rds")
)[, meta_pure_ccl4$sample]

pca_result <- do_pca(expr_pure_ccl4, meta_pure_ccl4, top_n_var_genes = 1000)

saveRDS(pca_result, here(output_path, "pca_result.rds"))

p1 <- plot_pca(pca_result, feature = "treatment") +
  my_theme() +
  ggtitle("CCl4 vs Oil")

# limit samples to 0 and 12 months
meta <- readRDS(here(data_path, "meta_data.rds")) |>
  filter(treatment != "oil") |>
  filter(time %in% c(0, 12))
expr <- readRDS(here(data_path, "normalized_expression.rds"))[, meta$sample]

pca_result <- do_pca(expr, meta, top_n_var_genes = 1000)

p2 <- plot_pca(pca_result, feature = "treatment") +
  my_theme() +
  ggtitle("CCl4 vs 0")

p1 + p2
```

## Enrichment analysis
```{r enrichment, warning=FALSE, fig.height=20, fig.width=10}
go_terms <- msigdf.mouse |>
  filter(category_subcode == "go.bp") |>
  select(geneset, gene = mouse.symbol) |>
  mutate(group = "go")

kegg_pathways <- msigdf.mouse |>
  filter(category_subcode == "cp.kegg") |>
  select(geneset, gene = mouse.symbol) |>
  mutate(group = "go")

genesets <- bind_rows(go_terms, kegg_pathways)

limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast %in% c("pure_ccl_12m_vs_0m", "ccl_12m_vs_0m"))

mat <- limma_result |>
  select(gene, contrast, logFC) |>
  pivot_wider(names_from = contrast, values_from = logFC) |>
  data.frame(row.names = 1)

res <- run_gsea(mat, genesets,
  options = list(minSize = 10), tidy = TRUE,
  nperm = 10000
) |>
  mutate(group = if_else(str_detect(geneset, "GOBP"), "GO", "KEGG"))

saveRDS(res, here(output_path, "enrichment_result.rds"))

res |>
  filter(padj <= 0.2) |>
  select(signature, geneset, pval, padj, ES, NES) |>
  datatable()

res |>
  arrange(NES) |>
  group_by(signature, group, sign(NES)) |>
  slice_max(abs(NES), n = 10) |>
  ggplot(aes(
    x = NES, y = reorder_within(geneset, NES, signature),
    fill = NES
  )) +
  geom_col() +
  scale_y_reordered() +
  # theme(axis.text.y = element_blank()) +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red")
  ) +
  my_theme(grid = "x") +
  facet_rep_wrap(~ signature + group, scales = "free_y", ncol = 1) +
  labs(y = NULL)
```



# Metabolic genes
## Annotate metabolic genes
This table displays all genes that are considered in this analysis
```{r annotate-genes, echo=TRUE}
# extract all possible genes
genes <- readRDS(here(data_path, "count_matrix.rds")) |>
  rownames_to_column("gene") |>
  as_tibble() |>
  select(gene)

genes <- genes |>
  mutate(family = case_when(
    str_detect(gene, "^Cyp") ~ "CYP",
    str_detect(gene, "^Ugt") ~ "UGT",
    str_detect(gene, "^Fmo") ~ "FMO",
    str_detect(gene, "^Mao") ~ "MAO",
    str_detect(gene, "^Cox") ~ "COX",
    str_detect(gene, "^Adh|Aldh") ~ "ADH/ALDH",
    str_detect(gene, "^Sult") ~ "SULT",
    str_detect(gene, "^Nat") ~ "NAT",
    str_detect(gene, "^Mt") ~ "MT",
    str_detect(gene, "^Nqor") ~ "NQOR",
    str_detect(gene, "^Gst") ~ "GST",
    str_detect(gene, "^Eph") ~ "EPH",
    str_detect(gene, "^Dh") ~ "DH",
    TRUE ~ NA_character_
  )) |>
  drop_na(family) |>
  mutate(phase = case_when(
    family %in% c(
      "CYP", "FMO", "MAO", "COX", "NQOR", "ADH/ALDH", "EPH", "DH"
    ) ~ "Phase I",
    family %in% c("GST", "UGT", "SULT", "NAT", "MT") ~ "Phase II",
  )) |>
  mutate(
    family = as_factor(family),
    phase = as_factor(phase)
  ) |>
  select(phase, family, gene)

saveRDS(genes, here(output_path, "metabolic_genes.rds"))

datatable(genes)
```

## Number of metabolic genes
```{r number-of-metabolic-genes}
metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds"))

metabolic_genes |>
  count(family, phase) |>
  ggplot(aes(x = family, y = n)) +
  geom_col() +
  facet_rep_wrap(~phase, scales = "free_x") +
  labs(x = "Gene familiy", y = "Number of genes") +
  my_theme(grid = "y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Fraction of differentially expressed metabolic genes
```{r fraction-deg-metabolic-genes, results="asis"}
metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  add_count(family, name = "size")

df <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m") |>
  inner_join(metabolic_genes, by = "gene")

df |>
  filter(regulation != "ns") |>
  count(gene, phase, family, size) |>
  count(phase, family, size) |>
  mutate(fraction = n / size) |>
  arrange(-fraction) |>
  kable(caption = str_c(
    "Fraction of gene family members that are differentially expressed"
  ))
```


## Enrichment analysis
```{r enrichment-metabolic-genes, warning=FALSE, fig.height=8}
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m")

metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  select(gene, geneset = family, phase)

mat <- limma_result |>
  select(gene, contrast, logFC) |>
  pivot_wider(names_from = contrast, values_from = logFC) |>
  data.frame(row.names = 1)

res <- run_gsea(mat, metabolic_genes, options = list(minSize = 10), tidy = TRUE)

res |>
  inner_join(distinct(metabolic_genes, geneset, phase), by = "geneset") |>
  mutate(signature = as_factor(signature)) |>
  ggplot(aes(
    x = reorder_within(geneset, NES, signature), y = NES, fill = NES
  )) +
  geom_col() +
  facet_rep_wrap(~phase, scales = "free_x", nrow = 1) +
  scale_x_reordered() +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red")
  ) +
  labs(x = "Metabolic gene family") +
  geom_text(
    aes(label = str_c("p = ", scientific(padj, 3), sep = " "), y = 0.85 * NES),
    color = "white", position = position_dodge(width = 0), size = 2.5
  ) +
  my_theme(grid = "y")
```


# Carrier genes
## Annotate carrier genes
```{r carrier-genes}
# define carrier genes and translate to mgi symbols
gene_mapping <- readRDS(here("data/annotation/gene_id_annotation.rds")) |>
  distinct(gene = symbol_mgi, symbol_hgnc)

carrier_genes <- tibble(
  symbol_hgnc = c(
    "SLC10A1", "SLCO1B1", "SLC22A1", "SLCO1B3", "SLC22A6", "ABCC4", "ABCC3",
    "SLC51A", "SLC51B", "ABCB11", "ABCC2", "ABCG2", "ABCG5", "ABCG8", "ATP8B1",
    "ABCB1", "ABCB4", "SLC47A1"
  ),
  side = c(
    rep("Blood", 9),
    rep("Canalicular", 9)
  )
) |>
  left_join(gene_mapping, by = "symbol_hgnc") |>
  distinct(gene, side) |>
  mutate(side = as_factor(side))

saveRDS(carrier_genes, here(output_path, "carrier_genes.rds"))

datatable(carrier_genes)
```

## Number of carrier genes
```{r number-of-carrier-genes}
carrier_genes <- readRDS(here(output_path, "carrier_genes.rds"))

carrier_genes |>
  count(side) |>
  ggplot(aes(x = side, y = n)) +
  geom_col() +
  labs(x = "Side", y = "Number of genes") +
  my_theme(grid = "y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Fraction of differentially expressed carrier genes
```{r fraction-deg-carrier-genes, results="asis"}
carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  add_count(side, name = "size")

df <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m") |>
  inner_join(carrier_genes, by = "gene")

df |>
  filter(regulation != "ns") |>
  count(gene, side, size) |>
  count(side, size) |>
  mutate(fraction = n / size) |>
  arrange(-fraction) |>
  kable(caption = str_c(
    "Fraction of gene family members that are differentially expressed"
  ))
```

## Enrichment analysis
```{r enrichment-carrier-genes, warning=FALSE, fig.height=8}
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m")

carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  select(gene, geneset = side)

mat <- limma_result |>
  select(gene, contrast, logFC) |>
  pivot_wider(names_from = contrast, values_from = logFC) |>
  data.frame(row.names = 1)

res <- run_gsea(mat, carrier_genes, options = list(minSize = 5), tidy = TRUE)

res |>
  inner_join(distinct(carrier_genes, geneset), by = "geneset") |>
  mutate(signature = as_factor(signature)) |>
  ggplot(aes(
    x = reorder_within(geneset, NES, signature), y = NES, fill = NES
  )) +
  geom_col() +
  scale_x_reordered() +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red")
  ) +
  labs(x = "Metabolic gene family") +
  geom_text(
    aes(label = str_c("p = ", scientific(padj, 3), sep = " "), y = 0.85 * NES),
    color = "white", position = position_dodge(width = 0), size = 2.5
  ) +
  my_theme(grid = "y")
```

# Overlap of metabolic, carrier and pericentral genes
```{r gene-overlap}
pericentral_genes <- readRDS(here("data/annotation/pericentral_genes.rds")) |>
  rename(category = zonation)

metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  select(gene, category = family)

carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  select(gene, category = side)

df <- bind_rows(pericentral_genes, metabolic_genes, carrier_genes) |>
  mutate(value = 1) |>
  pivot_wider(names_from = category, values_from = value, values_fill = 0) |>
  data.frame(check.names = FALSE)

upset(df, nsets = 20)
```

# Top differentially expressed metabolic and carrier genes
## Pure CCl4
```{r 12-month-deg-pure-ccl4, fig.height = 30}
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast %in% c("pure_ccl_12m_vs_0m", "ccl_12m_vs_0m")) |>
  filter(regulation != "ns")

carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  rename(geneset = side)
metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  rename(geneset = family)

genesets <- bind_rows(carrier_genes, metabolic_genes)

degs <- limma_result |>
  inner_join(genesets, by = "gene")

saveRDS(degs, here(output_path, "genesets_degs.rds"))

degs |>
  group_by(contrast, geneset, sign(logFC)) |>
  ggplot(aes(
    x = logFC, y = fct_reorder(gene, logFC),
    fill = logFC
  )) +
  geom_col() +
  facet_rep_grid(geneset ~ contrast, scales = "free_y") +
  my_theme(grid = "x") +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red")
  ) +
  labs(y = NULL) +
  theme(axis.text.y = element_text(size = 8))
```

# Tranlational analysis
## Translation of human genes to mouse genes
```{r gene-translation}
gene_mapping <- readRDS(here("data/annotation/gene_id_annotation.rds")) |>
  distinct(symbol_mgi, symbol_hgnc) |>
  # remove predicted genes that start with Gm followed by digits
  filter(!str_detect(symbol_mgi, "^Gm\\d+")) |>
  drop_na()

hs_limma_result <- readRDS(here("data/meta-mouse-vs-human/limma_result.rds")) |>
  rename(symbol_hgnc = gene) |>
  inner_join(gene_mapping, by = "symbol_hgnc")

# # example: 1 human gene with multiple mouse genes
# hs_limma_result |>
#   group_by(symbol_hgnc, contrast, phenotype, source) |>
#   filter(n() > 1) |>
#   ungroup()
#
# hs_limma_result |>
#   filter(symbol_hgnc == "CYP2A6")
#
# # example: 1 mouse genes with multiple human genes
# hs_limma_result |>
#   group_by(symbol_mgi, contrast, phenotype, source) |>
#   filter(n() > 1) |>
#   ungroup()
#
# hs_limma_result |>
#   # filter(symbol_mgi == "Rfc2") |>
#   filter(symbol_mgi == "Cyp2a5") |>
#   filter(contrast == "advanced_vs_mild") |>
#   group_by(gene = symbol_mgi, contrast, phenotype, source) |>
#   summarise(logFC = mean(logFC), statistic = mean(statistic),
#             combined_pval=combine.test(pval ,method="fisher"),
#             pval = if_else(n() == 1, pval[1], NA_real_),
#             fdr = combine.test(fdr, method="fisher"),
#             .groups="drop")

metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  select(symbol_mgi = gene, geneset = family) |>
  mutate(class = "metabolism")

carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  select(symbol_mgi = gene, geneset = side) |>
  mutate(class = "carrier")

genesets <- bind_rows(metabolic_genes, carrier_genes)


x <- hs_limma_result |>
  # join already now with genesets to eventually filter out mouse genes
  # that map to a single human gene but are not of interest for the downstream
  # analysis
  inner_join(genesets, by = "symbol_mgi") |>
  # 1 human gene with multiple mouse genes
  group_by(symbol_hgnc, geneset, class, contrast, phenotype, source) |>
  slice(1) |>
  ungroup() |>
  # 1 mouse gene with multiple human genes
  group_by(gene = symbol_mgi, geneset, class, contrast, phenotype, source) |>
  summarise(
    hs_logFC = mean(logFC), hs_statistic = mean(statistic),
    hs_combined_pval = combine.test(pval, method = "fisher"),
    hs_pval = if_else(n() == 1, pval[1], NA_real_),
    hs_combined_fdr = combine.test(fdr, method = "fisher"),
    hs_fdr = if_else(n() == 1, fdr[1], NA_real_),
    .groups = "drop"
  )
```

## Correlation of mouse-human-genes
```{r enrichment-in-human-diseases, message=FALSE, warning=FALSE, results="asis"}
metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds")) |>
  select(geneset = family, gene) |>
  mutate(class = "metabolism")

carrier_genes <- readRDS(here(output_path, "carrier_genes.rds")) |>
  select(gene, geneset = side) |>
  mutate(class = "carrier")

genesets <- bind_rows(metabolic_genes, carrier_genes)


mm_limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m") |>
  inner_join(genesets, by = "gene") |>
  select(gene,
    mm_logFC = logFC, mm_statistic = statistic, geneset,
    mm_fdr = fdr
  )

cor_test <- function(data, ...) {
  if (nrow(data) >= 5) {
    r <- cor.test(data$hs_logFC, data$mm_logFC, method = "pearson") |>
      tidy()
    return(r)
  } else {
    return(as_tibble(NULL))
  }
}

corr <- x |>
  inner_join(mm_limma_result, by = c("gene", "geneset")) |>
  mutate(sig = case_when(
    hs_fdr <= 0.05 & mm_fdr <= 0.05 ~ "Both species",
    hs_fdr <= 0.05 & mm_fdr > 0.05 ~ "Human only",
    hs_fdr > 0.05 & mm_fdr <= 0.05 ~ "Mouse only",
    hs_fdr > 0.05 & mm_fdr > 0.05 ~ "Neither human nor mouse",
    TRUE ~ "Missing human data"
  )) |>
  mutate(sig = factor(sig, levels = c(
    "Both species", "Mouse only",
    "Human only", "Neither human nor mouse",
    "Missing human data"
  ))) |>
  unite(key, contrast, phenotype, source, sep = " | ") |>
  nest(data = -c(key, geneset, class)) %>% # dplyr pipe here on purpose
  mutate(r = pmap(., .f = cor_test)) |>
  unnest(r) |>
  group_by(geneset) |>
  mutate(corr_fdr = p.adjust(p.value, method = "fdr")) |>
  ungroup()

saveRDS(corr, here(output_path, "correlations.rds"))

# heatmap of correlations
corr |>
  mutate(label = stars.pval(corr_fdr)) |>
  ggplot(aes(x = geneset, y = key, fill = estimate)) +
  geom_tile() +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red"), na.value = "yellow"
  ) +
  geom_text(aes(label = label), vjust = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p <- corr |>
  filter(corr_fdr <= 0.1) |>
  arrange(p.value) |>
  unnest(data) |>
  ggplot(aes(x = hs_logFC, y = mm_logFC, label = gene)) +
  geom_point(size = 1, aes(color = sig)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_rep_wrap(~ geneset + key, ncol = 2, scales = "free") +
  geom_smooth(method = "lm", se = FALSE, size = 0.5, formula = y ~ x) +
  my_theme() +
  labs(x = "Human logFC", y = "Mouse logFC")


ggplotly(p, height = 2500)
```


# Trajectories
## Metabolic genes
Only metabolic genes that are differentially expressed in **at least** one
timepoint are considered.
```{r trajectories-of-metabolic-genes, message=FALSE, warning=FALSE, results="asis"}
metabolic_genes <- readRDS(here(output_path, "metabolic_genes.rds"))

# find genes that are differentially expressed in at least one timepoint
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast_reference == "pure_ccl4") |>
  mutate(time = parse_number(as.character(contrast))) |>
  select(gene, pval, fdr, regulation, time)

degs <- limma_result |>
  filter(regulation != "ns") |>
  inner_join(metabolic_genes, by = "gene") |>
  distinct(gene, family, phase)

stem_result <- readRDS(here(data_path, "stem_result.rds")) |>
  inner_join(degs, by = "gene") |>
  left_join(limma_result, by = c("gene", "time"))

# plot trajectories for all gene family members separately
plotlist <- map(unique(degs$family), function(f) {
  p <- stem_result |>
    filter(family == {{ f }}) |>
    ggplot(aes(
      x = time, y = value, group = gene, color = family, pval = pval,
      fdr = fdr
    )) +
    geom_hline(yintercept = 0) +
    geom_line(alpha = 0.5) +
    geom_point(size = 0.25) +
    scale_x_continuous(breaks = unique(stem_result$time)) +
    scale_color_manual(values = brewer.pal(9, "Set1")) +
    labs(x = "Time", y = "logFC") +
    theme(
      strip.text = element_text(angle = 0, hjust = 0),
      legend.position = "none"
    ) +
    facet_rep_wrap(~profile, scales = "free", ncol = 4) +
    my_theme(grid = "y") +
    ggtitle(label = f)


  return(
    ggplotly(p,
      height = ceiling(length(unique(p$data$profile)) / 4) * 200 + 100
    )
  )
})

tagList(setNames(plotlist, NULL))

stem_result |>
  distinct(gene, family, phase, profile) |>
  select(phase, family, profile, gene) |>
  arrange(family, profile, gene) |>
  datatable()
```

## Carrier genes
Only genes that are differentially expressed in **at least** one timepoint are 
considered.
```{r trajectories-of-carrier-genes}
carrier_genes <- readRDS(here(output_path, "carrier_genes.rds"))

# find genes that are differentially expressed in at least one
# timepoint
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast_reference == "pure_ccl4") |>
  mutate(time = parse_number(as.character(contrast))) |>
  select(gene, pval, fdr, regulation, time)

degs <- limma_result |>
  inner_join(carrier_genes, by = "gene") |>
  filter(regulation != "ns") |>
  distinct(side, gene)

stem_result <- readRDS(here(data_path, "stem_result.rds")) |>
  inner_join(degs, by = "gene") |>
  left_join(limma_result, by = c("gene", "time"))

p <- stem_result |>
  ggplot(aes(
    x = time, y = value, group = gene, pval = pval, fdr = fdr,
    color = side
  )) +
  geom_hline(yintercept = 0) +
  geom_line(alpha = 0.5) +
  geom_point(size = 0.25) +
  scale_x_continuous(breaks = unique(stem_result$time)) +
  labs(x = "Time", y = "logFC") +
  theme(
    strip.text = element_text(angle = 0, hjust = 0),
    legend.position = "top"
  ) +
  facet_rep_wrap(~profile, scales = "free", ncol = 4) +
  my_theme(grid = "y") +
  ggtitle(label = "Carrier genes")

ggplotly(p, height = ceiling(length(unique(p$data$profile)) / 4) * 200 + 100)

stem_result |>
  distinct(gene, side, profile) |>
  select(side, profile, gene) |>
  arrange(side, gene) |>
  datatable()
```

# Publication figures
```{r}
fz <- 9
```

## Figure 1
### PCA
```{r pca-plot}
pca_result <- readRDS(here(output_path, "pca_result.rds"))

# limit pca ratio to one decimal digit
pca_result$var <- round(pca_result$var, 1)

pca_result$coords <- pca_result$coords |>
  mutate(treatment = str_to_title(treatment))

p1 <- plot_pca(pca_result, feature = "treatment") +
  scale_color_manual(
    values = aachen_color(c("turquoise", "orange")),
    labels = c(expression(paste(CCl[4])), expression(paste(Oil))),
    name = "Treatment"
  ) +
  theme(legend.text.align = 0) +
  my_theme(fsize = fz) +
  plot_annotation(
    title = "A",
    theme = theme(plot.title = element_text(size = fz + 2))
  )

ggsave(here("figures/pca_plot.pdf"), p1, width = 3.5 * 1.2, height = 3.5)
```

### Enrichemnt
```{r "enrichment-plot"}
res <- readRDS(here(output_path, "enrichment_result.rds")) |>
  filter(signature == "pure_ccl_12m_vs_0m") |>
  mutate(geneset = str_remove(geneset, "GOBP_|KEGG_")) |>
  mutate(geneset = str_replace_all(geneset, "_", " ")) |>
  mutate(geneset = str_to_title(geneset))

data_go <- res |>
  filter(group == "GO") |>
  filter(padj <= 0.2) |>
  mutate(stars = gtools::stars.pval(padj)) |>
  arrange(NES) |>
  group_by(signature, group, sign(NES)) |>
  slice_max(abs(NES), n = 10) |>
  ungroup()

p_go <- plot_top_enrichment_results(data_go, class = "GO terms", fontsize = fz)

ggsave(here("figures/enriched_go_terms.pdf"), p_go, width = 8, height = 4)


data_kegg <- res |>
  filter(group == "KEGG") |>
  filter(padj <= 0.2) |>
  mutate(stars = gtools::stars.pval(padj)) |>
  arrange(NES) |>
  group_by(signature, group, sign(NES)) |>
  slice_max(abs(NES), n = 10) |>
  ungroup()

p_kegg <- plot_top_enrichment_results(data_kegg,
  class = "KEGG pathways",
  fontsize = fz
)

ggsave(here("figures/enriched_kegg_pathways.pdf"), p_kegg,
  width = 8,
  height = 4
)
```

### Top DEGs
```{r plot-top-degs}
degs <- readRDS(here(output_path, "genesets_degs.rds")) |>
  filter(contrast == "pure_ccl_12m_vs_0m") |>
  mutate(geneset_label = case_when(
    geneset == "ADH/ALDH" ~ "Alcohol- and aldehyddehydrogenases (ADH/ALDH)",
    geneset == "CYP" ~ "Cytochrome p450 dependent monooxygenases (CYP)",
    geneset == "DH" ~ "Dihydrodioldehydrogenases (DH)",
    geneset == "EPH" ~ "Epoxidhydrolases (EPH)",
    geneset == "FMO" ~ "Flavin dependent monooxygenases (FMO)",
    geneset == "GST" ~ "Glutathiontransferases (GST)",
    geneset == "MAO" ~ "Monoamine oxidases (MAO)",
    geneset == "MT" ~ "Methyltransferases (MT)",
    geneset == "NAT" ~ "Acetyltransferases (NAT)",
    geneset == "SULT" ~ "Sulfotransferases (SULT)",
    geneset == "UGT" ~ "UDP-glucuronosyltransferases (UGT)",
    geneset == "Blood" ~ "Blood side carrier",
    geneset == "Canalicular" ~ "Canalicular side carrier",
    TRUE ~ as.character(geneset)
  ))

deg_plots <- degs |>
  mutate(stars = gtools::stars.pval(fdr)) |>
  arrange(logFC) |>
  group_by(geneset, sign(logFC)) |>
  slice_max(abs(logFC), n = 10) |>
  add_count() |>
  ungroup() |>
  group_by(geneset) |>
  mutate(n = max(n)) |>
  ungroup() |>
  nest(data = -c(geneset, geneset_label, n, phase)) %>%
  mutate(p = pmap(., .f = plot_top_deg_genes, fontsize = 9))

deg_plots %>%
  mutate(pp = pmap(., .f = function(p, geneset, n, ...) {
    heights <- list(
      Blood = 2.05, Canalicular = 1.75, `ADH/ALDH` = 2.35, CYP = 3.1, DH = 1.55,
      EPH = 1.75, FMO = 1.75, GST = 2.55, MAO = 1.55, MT = 2.3, NAT = 2.3,
      SULT = 2.55, UGT = 2.35
    )

    if (geneset == "Blood") {
      p <- p + plot_annotation(
        title = "D   Carrier",
        theme = theme(plot.title = element_text(size = fz + 2))
      )
    } else if (geneset == "ADH/ALDH") {
      p <- p + plot_annotation(
        title = "B   Phase I Metabolism",
        theme = theme(plot.title = element_text(size = fz + 2))
      )
    } else if (geneset == "UGT") {
      p <- p + plot_annotation(
        title = "C   Phase II Metabolism",
        theme = theme(plot.title = element_text(size = fz + 2))
      )
    }

    # height = 1.05 + 0.2*n
    ggsave(
      filename = here(
        str_glue("figures/{str_replace(geneset, '/', '_')}.pdf")
      ),
      # filename = str_glue("~/Documents/figures/{str_replace(geneset, '/', '_')}.pdf"),
      plot = p,
      width = 3.5,
      height = heights[[as.character(geneset)]]
    )
    return(as_tibble(NULL))
  }))
```

## Figure 2
### Single correlations
```{r single-correlation-plots}
corr <- readRDS(here(output_path, "correlations.rds")) |>
  filter(corr_fdr <= 0.1) |>
  arrange(p.value) |>
  unnest(data) |>
  mutate(anno = str_glue(
    "  r={round(estimate, 2)}\nFDR={signif(corr_fdr, digits=2)}"
  ))

p1 <- corr |>
  filter(key == "stage_6_vs_0 | nafld | hoang" & geneset == "DH") |>
  plot_correlation() +
  labs(
    x = "Human logFC (NAFLD Stage 6)",
    y = expression(paste("Mouse logFC (12 months ", CCl[4], ")", sep = "")),
    subtitle = "Dihydrodioldehydrogenases (DH)"
  ) +
  plot_annotation(
    title = "A",
    theme = theme(plot.title = element_text(size = fz + 2))
  )

ggsave("~/Documents/figures/correlation_1.pdf", p1, width = 3.5, height = 3.5)

p2 <- corr |>
  filter(key == "nash_vs_ctrl | omni | hampe14" & geneset == "NAT") |>
  plot_correlation() +
  labs(
    x = "Human logFC (NASH)",
    y = expression(paste("Mouse logFC (12 months ", CCl[4], ")", sep = "")),
    subtitle = "Acetyltransferases (NAT)"
  ) +
  plot_annotation(
    title = "B",
    theme = theme(plot.title = element_text(size = fz + 2))
  )

ggsave("~/Documents/figures/correlation_2.pdf", p2, width = 3.5, height = 3.5)

p3 <- corr |>
  filter(key == "nafld_vs_ctrl | omni | hampe14" & geneset == "ADH/ALDH") |>
  plot_correlation() +
  labs(
    x = "Human logFC (NAFLD)",
    y = expression(paste("Mouse logFC (12 months ", CCl[4], ")", sep = "")),
    subtitle = "Alcohol- and aldehyddehydrogenases (ADH/ALDH)"
  ) +
  plot_annotation(
    title = "C",
    theme = theme(plot.title = element_text(size = fz + 2))
  )

ggsave("~/Documents/figures/correlation_3.pdf", p3, width = 3.5, height = 3.5)


p1 / p2 / p3
```

### Correlation heatmap
```{r correlation-heatmap}
annotation <- readRDS(
  here("data/meta-mouse-vs-human/contrast_annotation.rds")
) |>
  select(contrast, phenotype, source, label, disease)
corr <- readRDS(here(output_path, "correlations.rds")) |>
  separate(key, into = c("contrast", "phenotype", "source"), sep = " [|] ") |>
  left_join(annotation, by = c("contrast", "phenotype", "source")) |>
  complete(geneset, label, fill = list(estimate = NA_real_)) |>
  mutate(y = str_c(label, " | ", geneset)) |>
  mutate(x = str_c("CCl4 12 months| ", geneset)) |>
  mutate(highlight = case_when(
    geneset == "ADH/ALDH" & contrast == "nafld_vs_ctrl" & phenotype == "omni" &
      source == "hampe14" ~ "yes",
    geneset == "DH" & contrast == "stage_6_vs_0" & phenotype == "nafld" &
      source == "hoang" ~ "yes",
    geneset == "NAT" & contrast == "nash_vs_ctrl" & phenotype == "omni" &
      source == "hampe14" ~ "yes",
    TRUE ~ "no"
  )) |>
  mutate(stars = stars.pval(corr_fdr))

# heatmap of correlations
p4 <- corr |>
  ggplot(aes(x = geneset, y = label, fill = estimate)) +
  geom_tile(width = 0.95, height = 0.95) +
  geom_tile(
    data = filter(corr, highlight == "yes"), fill = NA,
    color = aachen_color("red"), size = 0.5
  ) +
  scale_fill_gradient2(
    low = aachen_color("orange"),
    mid = "white",
    high = aachen_color("green"),
    na.value = aachen_color("black25"),
    breaks = c(-1, 0, 1), labels = c(-1, 0, 1),
    limits = c(-1, 1)
  ) +
  scale_color_manual(values = c("white", aachen_color("red"))) +
  geom_text(
    data = filter(corr, stars != "."), aes(label = stars),
    vjust = 1, size = fz / (14 / 5)
  ) +
  geom_text(
    data = filter(corr, stars == "."), aes(label = stars),
    vjust = 0, size = fz / (14 / 5)
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Mouse", y = "Human") +
  guides(fill = guide_colorbar("r"), color = "none") +
  theme(axis.line = element_blank(), axis.ticks = element_blank()) +
  my_theme(grid = "no", fsize = fz) +
  plot_annotation(
    title = "D",
    theme = theme(plot.title = element_text(size = fz + 2))
  )

ggsave("~/Documents/figures/heatmap.pdf", p4, width = 5.3, height = 4)
```

# References
