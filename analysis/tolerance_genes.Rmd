---
title: "Analysis of 'tolerance' genes"
site: workflowr::wflow_site
bibliography: ../data/references/references.bib
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE
)
```


# Introduction
In this analysis I check the expression of 210 genes (in the following referred 
to as 'tolerance' genes) in the 1 year CCl4 chronic liver disease mouse model

# Libraries and sources
These libraries and sources are used for this analysis.
```{r libs-and-src, message=FALSE, warning=FALSE, cache=FALSE, echo=TRUE}
# data wrangling
library(tidyverse)
library(readxl)

# statistics
library(fgsea)

# plotting
library(lemon)
library(tidytext)
library(plotly)
library(scales)

# colors
library(AachenColorPalette)
library(RColorBrewer)

# display tables
library(DT)

# development helpers
library(here)
library(devtools)

base_url <- "https://raw.githubusercontent.com/saezlab/liver-disease-atlas"
source_url(file.path(base_url, "master", "code", "utils-plots.R"))
source_url(file.path(base_url, "master", "code", "utils-utils.R"))
```

Definition of global variables that are used throughout this analysis.
```{r analysis-specific-params, cache=FALSE}
data_path <- "data/mouse-chronic-ccl4"
output_path <- "output/seddik"
```

## Annotate genes
```{r annotate-genes, echo=TRUE}
# extract gene names
genes <- read_excel(here("data/annotation/210genes.xlsx")) |>
  select(entrez = EntrezID, gene = Symbol) |>
  arrange(gene)

saveRDS(genes, here(output_path, "genes_of_interest.rds"))
```

## Coverage
How many of those 210 genes are covered in the dataset?
```{r gene-coverage}
genes <- readRDS(here(output_path, "genes_of_interest.rds"))
df <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast_reference == "pure_ccl4") |>
  distinct(gene) |>
  mutate(covered = "yes")

df <- genes |>
  left_join(df, by = "gene") |>
  replace_na(list(covered = "no"))
```


```{r gene-coverage-2}
df |>
  count(covered) |> 
  datatable()
```

Table of the 'tolerance' indicating whether the gene is covered in the dataset
```{r gene-coverage-3}
df |>
  datatable()
```

## Enrichment analysis
Enrichment analysis of the 'tolerance' genes within the 12 month CCl4 signature.
```{r enrichment, warning=FALSE, fig.height=4}
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast %in% c("pure_ccl_12m_vs_0m", "ccl_12m_vs_0m"))
genes <- readRDS(here(output_path, "genes_of_interest.rds")) |>
  mutate(geneset = "210")

mat <- limma_result |>
  select(gene, contrast, logFC) |>
  pivot_wider(names_from = contrast, values_from = logFC) |>
  data.frame(row.names = 1)

res <- run_gsea(mat, genes, options = list(minSize = 10), tidy = TRUE)
```

The tolerance genes are significantly enriched in the up-regulated genes of the 
12 month CCl4 signature
```{r enrichment-2, warning=FALSE, fig.height=4}
res |>
  filter(signature == "pure_ccl_12m_vs_0m") |> 
  mutate(signature = as_factor(signature)) |>
  ggplot(aes(
    x = signature, y = NES, fill = NES
  )) +
  geom_col() +
  # scale_fill_gradient2(
  #   low = aachen_color("blue"), mid = "white",
  #   high = aachen_color("red")
  # ) +
  labs(x=NULL) +
  geom_text(
    aes(label = str_c("p = ", scientific(padj, 3), sep = " "), y = 0.85 * NES),
    color = "white", position = position_dodge(width = 0), size = 2.5
  ) +
  my_theme(grid = "y") +
  labs(x=NULL)
```

## Differentially expressed genes
Bar plots of the differentially expressed 'tolerance' genes 
(abs(logFC) >= 1 & FDR <= 0.05) at time point 12 month
```{r differentially-expressed-genes, message=FALSE, warning=FALSE, fig.height=12}
genes <- readRDS(here(output_path, "genes_of_interest.rds"))

# find genes that are differentially expressed in at least one timepoint
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast %in% c("ccl_12m_vs_0m", "pure_ccl_12m_vs_0m"))

limma_result |>
  filter(contrast == "pure_ccl_12m_vs_0m") |> 
  filter(regulation != "ns") |>
  inner_join(genes, by = "gene") |>
  ggplot(aes(
    y = fct_reorder(gene, logFC),
    x = logFC, fill = logFC
  )) +
  scale_fill_gradient2(
    low = aachen_color("blue"), mid = "white",
    high = aachen_color("red")
  ) +
  geom_col() +
  facet_rep_wrap(~contrast) +
  my_theme(grid = "x") +
  labs(y = "Gene", x="logFC") +
  theme(axis.text.y = element_text(size = 8))
```

## Trajectories
Time course of 'tolerance' genes that are differentially expressed in at least 
one time point (either 2, 6 or 12 months). These are interactive plots. Hovering 
with the mouse over the dots will show the gene name.
```{r gene-trajectories, message=FALSE, warning=FALSE, results="asis"}
genes <- readRDS(here(output_path, "genes_of_interest.rds"))

# find genes that are differentially expressed in at least one timepoint
limma_result <- readRDS(here(data_path, "limma_result.rds")) |>
  filter(contrast_reference == "pure_ccl4") |>
  mutate(time = parse_number(as.character(contrast))) |>
  select(gene, pval, fdr, regulation, time)

degs <- limma_result |>
  filter(regulation != "ns") |>
  inner_join(genes, by = "gene") |>
  distinct(gene)

stem_result <- readRDS(here(data_path, "stem_result.rds")) |>
  inner_join(degs, by = "gene") |>
  left_join(limma_result, by = c("gene", "time"))

# plot trajectories for all gene family members separately
p <- stem_result |>
  ggplot(aes(
    x = time, y = value, group = gene, pval = pval,
    fdr = fdr
  )) +
  geom_hline(yintercept = 0) +
  geom_line(alpha = 0.5) +
  geom_point(size = 0.25) +
  scale_x_continuous(breaks = unique(stem_result$time)) +
  scale_color_manual(values = brewer.pal(9, "Set1")) +
  labs(x = "Time", y = "logFC") +
  theme(
    strip.text = element_text(angle = 0, hjust = 0),
    legend.position = "none"
  ) +
  facet_rep_wrap(~profile, scales = "free", ncol = 4) +
  my_theme(grid = "y")

ggplotly(p)


```

This table summarizes the genes that are displayed in the trajectories plot
```{r gene-trajectories-2, message=FALSE, warning=FALSE, results="asis"}
stem_result |>
  distinct(gene, profile) |>
  select(profile, gene) |>
  arrange(profile, gene) |>
  datatable()
```

